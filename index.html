<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenUI | Conversational Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .sticky-nav {
            position: sticky;
            top: 0;
            z-index: 50;
            transition: all 0.3s ease;
        }

        .preview-area {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Intercepting Button Highlight */
        #app-container button:hover {
            cursor: pointer;
            border: 2px solid rgba(59, 130, 246, 0.5) !important;
        }
    </style>
</head>

<body class="text-slate-900 flex flex-col">

    <!-- Header: Server & API Key Only -->
    <header class="sticky-nav glass px-6 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div
                class="w-9 h-9 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                <svg viewBox="0 0 24 24" class="w-5 h-5 fill-current">
                    <path
                        d="M21 16.5C21 16.88 20.79 17.21 20.47 17.38L12.57 21.82C12.41 21.94 12.21 22 12 22C11.79 22 11.59 21.94 11.43 21.82L3.53 17.38C3.21 17.21 3 16.88 3 16.5V7.5C3 7.12 3.21 6.79 3.53 6.62L11.43 2.18C11.59 2.06 11.79 2 12 2C12.21 2 12.41 2.06 12.57 2.18L20.47 6.62C20.79 6.79 21 7.12 21 7.5V16.5Z">
                    </path>
                </svg>
            </div>
            <h1 class="text-lg font-bold tracking-tight text-slate-800">GenUI <span
                    class="text-indigo-500 font-medium">Studio</span></h1>
        </div>

        <div class="flex gap-4 items-center">
            <div class="relative group">
                <select id="ai-provider" onchange="handleProviderChange()"
                    class="bg-slate-100/50 border-none rounded-lg px-3 py-2 text-[10px] font-bold text-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                    <option value="openai">OpenAI</option>
                    <option value="gemini">Gemini</option>
                    <option value="local">Local LLM</option>
                </select>
            </div>
            <div class="relative group">
                <input type="text" id="server-url" placeholder="Backend (Python)"
                    class="w-32 bg-slate-100/50 border-none rounded-lg px-3 py-2 text-[10px] focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                    onchange="saveConfig()">
            </div>
            <div class="relative group">
                <input type="text" id="llm-url" placeholder="LLM Endpoint"
                    class="w-40 bg-slate-100/50 border-none rounded-lg px-3 py-2 text-[10px] focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                    onchange="saveConfig()">
            </div>
            <div class="relative group flex items-center">
                <input type="text" id="llm-model" list="model-list" placeholder="Model"
                    class="w-32 bg-slate-100/50 border-none rounded-l-lg px-3 py-2 text-[10px] focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                    onchange="saveConfig()">
                <button onclick="fetchModels()"
                    class="bg-indigo-500 hover:bg-indigo-600 text-white rounded-r-lg px-2 py-2 text-[10px] transition-colors shadow-sm"
                    title="Fetch Models">
                    Refresh
                </button>
                <datalist id="model-list"></datalist>
            </div>
            <div class="relative group">
                <input type="password" id="api-key" placeholder="API Key"
                    class="w-32 bg-slate-100/50 border-none rounded-lg px-3 py-2 text-[10px] focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                    onchange="saveConfig()">
            </div>
            <div class="flex items-center gap-2 border-l border-slate-200 ml-2 pl-4">
                <button onclick="createNewSession()"
                    class="text-xs font-bold text-indigo-600 hover:text-indigo-700 transition-colors px-2">
                    + New
                </button>
                <button onclick="toggleHistory()"
                    class="text-xs font-semibold text-slate-500 hover:text-indigo-600 transition-colors px-2">
                    History
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">

        <!-- Preview Panel -->
        <section id="app-wrapper" class="flex-1 flex flex-col p-6 overflow-hidden">
            <div id="app-container"
                class="preview-area flex-1 bg-white rounded-3xl shadow-2xl shadow-slate-200/50 border border-slate-100 overflow-auto flex flex-col items-center justify-center p-12">
                <div class="text-center space-y-8 max-w-lg fade-in">
                    <div
                        class="w-24 h-24 bg-indigo-50 rounded-3xl flex items-center justify-center mx-auto mb-6 text-indigo-500 shadow-inner">
                        <svg viewBox="0 0 24 24" class="w-12 h-12 fill-current">
                            <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"></path>
                        </svg>
                    </div>
                    <h3 class="text-4xl font-black text-slate-800 tracking-tight">Generate the Future</h3>
                    <p class="text-slate-500 text-lg">Type your idea below to start. Every button in the generated UI
                        will act as a new instruction for the AI.</p>

                    <!-- Quick Sample Message Hints -->
                    <div class="grid grid-cols-2 gap-4 pt-4">
                        <div onclick="sendAction('Create an Analytics Dashboard')"
                            class="p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:border-indigo-200 hover:bg-white cursor-pointer transition-all text-left group">
                            <span class="text-xl block mb-2 font-bold text-indigo-500">Analytics</span>
                            <p class="text-xs font-bold text-slate-400 group-hover:text-indigo-600">SAMPLE MESSAGE</p>
                            <p class="text-sm font-medium text-slate-700">Analytics Dashboard</p>
                        </div>
                        <div onclick="sendAction('Create a Luxury Brand Login')"
                            class="p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:border-indigo-200 hover:bg-white cursor-pointer transition-all text-left group">
                            <span class="text-xl block mb-2 font-bold text-indigo-500">Luxury</span>
                            <p class="text-xs font-bold text-slate-400 group-hover:text-indigo-600">SAMPLE MESSAGE</p>
                            <p class="text-sm font-medium text-slate-700">Luxury Brand Login</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Global Prompt Bar -->
            <div class="mt-8 mx-auto w-full max-w-4xl relative">
                <div id="status-indicator"
                    class="hidden absolute -top-8 left-6 text-xs font-bold text-indigo-600 flex items-center gap-2">
                    <div class="loader"></div> Processing logic...
                </div>
                <div class="bg-white p-2 rounded-[2rem] shadow-2xl border border-slate-100 flex items-center gap-2">
                    <input type="text" id="user-intent" placeholder="Describe your UI or click a button above..."
                        class="flex-1 bg-transparent px-6 py-4 text-slate-800 placeholder-slate-400 focus:ring-0 outline-none text-lg"
                        onkeypress="if(event.key === 'Enter') sendAction(this.value)">
                    <button onclick="sendAction(document.getElementById('user-intent').value)"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white w-14 h-14 rounded-[1.5rem] flex items-center justify-center shadow-xl shadow-indigo-200 transition-all active:scale-90 overflow-hidden">
                        <svg viewBox="0 0 24 24" class="w-6 h-6 fill-current">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </section>

        <!-- History Sidebar -->
        <aside id="history-sidebar" class="hidden w-72 bg-white border-l border-slate-100 p-6 flex flex-col fade-in">
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 px-1">Recent Versions</h2>
            <div id="history-list" class="flex-1 space-y-3 overflow-y-auto pb-10">
                <p class="text-slate-300 text-xs italic px-1">Log is empty</p>
            </div>
        </aside>
    </main>

    <script>
        const HISTORY_KEY = 'genui_history';
        document.addEventListener('DOMContentLoaded', () => {
            const provider = localStorage.getItem('ai_provider') || 'openai';
            const server = localStorage.getItem('server_url');
            const llmUrl = localStorage.getItem('llm_url');
            const llmModel = localStorage.getItem('llm_model');
            const key = localStorage.getItem('openai_api_key');

            document.getElementById('ai-provider').value = provider;
            if (server) document.getElementById('server-url').value = server;
            if (llmUrl) document.getElementById('llm-url').value = llmUrl;
            if (llmModel) document.getElementById('llm-model').value = llmModel;
            if (key) document.getElementById('api-key').value = key;

            updateHistoryUI();

            // --- CRITICAL: Event Delegation for Intercepting Button Clicks ---
            const container = document.getElementById('app-container');
            container.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button) {
                    e.preventDefault();
                    e.stopPropagation();
                    const btnText = button.innerText.trim() || 'unnamed';
                    sendAction(`User pushed [${btnText}] button. Create next HTML context.`);
                }
            });
        });

        // Backend URL Helper
        function getBackendUrl() {
            let url = document.getElementById('server-url').value.trim().replace(/\/$/, '');
            if (!url && window.location.protocol === 'file:') return 'http://127.0.0.1:8000';
            if (url && !/^https?:\/\//i.test(url)) url = 'http://' + url;
            return url;
        }

        async function fetchModels() {
            const llmUrl = document.getElementById('llm-url').value;
            const apiKey = document.getElementById('api-key').value;
            const serverUrl = getBackendUrl();

            if (!llmUrl && !apiKey) {
                alert("Please provide LLM Base URL or API Key first.");
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/models?llm_url=${encodeURIComponent(llmUrl)}&api_key=${encodeURIComponent(apiKey)}`);
                if (!response.ok) {
                    let detail = "Check your connection or API configuration.";
                    try {
                        const err = await response.json();
                        detail = err.detail || detail;
                    } catch (e) {
                        detail = `HTTP ${response.status}: Route or server not found.`;
                    }
                    throw new Error(detail);
                }

                const data = await response.json();
                const datalist = document.getElementById('model-list');
                datalist.innerHTML = data.models.map(m => `<option value="${m}">`).join('');

                const modelInput = document.getElementById('llm-model');
                if (!modelInput.value && data.models.length > 0) {
                    modelInput.value = data.models[0];
                    saveConfig();
                }
            } catch (err) {
                console.error(err);
                alert(`Fetch Error: ${err.message}\n(Backend: ${serverUrl})`);
            }
        }

        function handleProviderChange() {
            const provider = document.getElementById('ai-provider').value;
            const llmUrlInput = document.getElementById('llm-url');
            const modelInput = document.getElementById('llm-model');
            const serverInput = document.getElementById('server-url');

            if (provider === 'openai') {
                llmUrlInput.value = ""; // Use OpenAI default
                modelInput.value = "gpt-4o";
                serverInput.value = window.location.origin.includes('8001') ? "http://127.0.0.1:8000" : (localStorage.getItem('server_url') || "http://127.0.0.1:8000");
            } else if (provider === 'gemini') {
                // More robust Gemini OpenAI-compatible base
                llmUrlInput.value = "https://generativelanguage.googleapis.com/v1beta/";
                modelInput.value = "gemini-1.5-pro-latest";
                serverInput.value = "http://127.0.0.1:8001";
            } else if (provider === 'local') {
                llmUrlInput.value = "http://localhost:11434/v1";
                modelInput.value = "";
                serverInput.value = "http://127.0.0.1:8000";
            }
            saveConfig();
        }

        function saveConfig() {
            localStorage.setItem('ai_provider', document.getElementById('ai-provider').value);
            localStorage.setItem('server_url', document.getElementById('server-url').value);
            localStorage.setItem('llm_url', document.getElementById('llm-url').value);
            localStorage.setItem('llm_model', document.getElementById('llm-model').value);
            localStorage.setItem('openai_api_key', document.getElementById('api-key').value);
        }

        async function sendAction(intent) {
            if (!intent || intent.trim() === "") return;

            const apiKey = document.getElementById('api-key').value;
            const llmUrl = document.getElementById('llm-url').value;
            const llmModel = document.getElementById('llm-model').value;
            const container = document.getElementById('app-container');
            const status = document.getElementById('status-indicator');
            const input = document.getElementById('user-intent');

            if (!apiKey && !llmUrl) {
                alert("Please provide an OpenAI API Key OR a Local LLM URL.");
                return;
            }

            const serverUrl = getBackendUrl();
            const currentHtml = container.innerHTML;
            input.value = "";
            status.classList.remove('hidden');

            try {
                const response = await fetch(`${serverUrl}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_key: apiKey,
                        system_prompt: "",
                        user_action: intent,
                        current_html: currentHtml,
                        llm_url: llmUrl,
                        model: llmModel
                    })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.detail || `Server error: ${response.status}`);
                }

                const data = await response.json();
                if (data.html) {
                    container.classList.remove('items-center', 'justify-center', 'p-12');
                    container.classList.add('block');
                    container.innerHTML = data.html;
                    updateHistoryUI(); // Refresh from server
                }
            } catch (err) {
                console.error(err);
                alert(`Connection Failed to: ${serverUrl}\n\nError: ${err.message}`);
            } finally {
                status.classList.add('hidden');
            }
        }

        async function updateHistoryUI() {
            const list = document.getElementById('history-list');
            const serverUrl = getBackendUrl();

            try {
                const response = await fetch(`${serverUrl}/history`);
                if (!response.ok) {
                    list.innerHTML = '<p class="text-slate-300 text-xs italic px-1">Log is empty</p>';
                    return;
                }

                const history = await response.json();
                if (!history || history.length === 0) {
                    list.innerHTML = '<p class="text-slate-300 text-xs italic px-1">Log is empty</p>';
                    return;
                }

                list.innerHTML = history.map((item) => `
                    <div onclick="restoreHistory('${item.filename}')" class="bg-slate-50/50 p-3 rounded-xl border border-slate-100 cursor-pointer hover:border-indigo-300 hover:bg-white transition-all">
                        <p class="text-[10px] font-bold text-slate-800 truncate uppercase tracking-tight">${item.intent.substring(0, 30)}...</p>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-[9px] text-slate-400 font-medium">${item.time}</span>
                            <span class="text-[8px] bg-slate-200 text-slate-500 px-1 rounded">${item.model || 'llm'}</span>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error("History fetch error:", err);
                list.innerHTML = '<p class="text-slate-300 text-xs italic px-1">Error loading history</p>';
            }
        }

        async function restoreHistory(filename) {
            const serverUrl = getBackendUrl();
            const container = document.getElementById('app-container');

            try {
                const response = await fetch(`${serverUrl}/logs/${filename}`);
                if (!response.ok) throw new Error("Could not load file");

                const html = await response.text();

                // Extract body content if it's a full doc
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const content = doc.body ? doc.body.innerHTML : html;

                container.classList.remove('items-center', 'justify-center', 'p-12');
                container.classList.add('block');
                container.innerHTML = content;
            } catch (err) {
                alert("Failed to restore: " + err.message);
            }
        }

        const WELCOME_HTML = `
            <div class="text-center space-y-8 max-w-lg fade-in">
                <div class="w-24 h-24 bg-indigo-50 rounded-3xl flex items-center justify-center mx-auto mb-6 text-indigo-500 shadow-inner">
                    <svg viewBox="0 0 24 24" class="w-12 h-12 fill-current"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"></path></svg>
                </div>
                <h3 class="text-4xl font-black text-slate-800 tracking-tight">Generate the Future</h3>
                <p class="text-slate-500 text-lg">Type your idea below to start. Every button in the generated UI will act as a new instruction for the AI.</p>
                <div class="grid grid-cols-2 gap-4 pt-4">
                    <div onclick="sendAction('Create an Analytics Dashboard')" class="p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:border-indigo-200 hover:bg-white cursor-pointer transition-all text-left group">
                        <span class="text-xl block mb-2 font-bold text-indigo-500">Analytics</span>
                        <p class="text-xs font-bold text-slate-400 group-hover:text-indigo-600">SAMPLE MESSAGE</p>
                        <p class="text-sm font-medium text-slate-700">Analytics Dashboard</p>
                    </div>
                    <div onclick="sendAction('Create a Luxury Brand Login')" class="p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:border-indigo-200 hover:bg-white cursor-pointer transition-all text-left group">
                        <span class="text-xl block mb-2 font-bold text-indigo-500">Luxury</span>
                        <p class="text-xs font-bold text-slate-400 group-hover:text-indigo-600">SAMPLE MESSAGE</p>
                        <p class="text-sm font-medium text-slate-700">Luxury Brand Login</p>
                    </div>
                </div>
            </div>
        `;

        function createNewSession() {
            const container = document.getElementById('app-container');
            const input = document.getElementById('user-intent');

            container.classList.add('items-center', 'justify-center', 'p-12');
            container.classList.remove('block');
            container.innerHTML = WELCOME_HTML;
            input.value = "";

            // Optional: Close history if open
            document.getElementById('history-sidebar').classList.add('hidden');
        }

        function toggleHistory() {
            const sidebar = document.getElementById('history-sidebar');
            sidebar.classList.toggle('hidden');
            if (!sidebar.classList.contains('hidden')) updateHistoryUI();
        }
    </script>
</body>

</html>